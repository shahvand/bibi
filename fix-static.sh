#!/bin/bash

echo "๐ ุชุดุฎุต ู ุฑูุน ูุดฺฉู ูุงูโูุง ุงุณุชุงุชฺฉ ูพูู ุงุฏูู..."

# ุชููู ฺฉุงูุชูุฑูุง ุจุฏูู ุญุฐู ููููโูุง
echo "๐ ุชููู ูููุช ฺฉุงูุชูุฑูุง..."
docker compose stop

# ฺฉูพ ูุงูโูุง ุงุฏูู ุจู ุตูุฑุช ุฏุณุช
echo "๐๏ธ ุงุฌุงุฏ ุฏุงุฑฺฉุชูุฑโูุง ูุงุฒู ุจุฑุง ูุงูโูุง ุงุณุชุงุชฺฉ..."
mkdir -p static/admin/css
mkdir -p static/admin/js
mkdir -p static/admin/img

# ูุงุฑุฏ ฺฉุฑุฏู ูุงูโูุง ุงุณุชุงุชฺฉ ูพูู ุงุฏูู
echo "๐ ฺฉูพ ูุงูโูุง ุงุณุชุงุชฺฉ ูพูู ุงุฏูู..."
echo "ุงู ูุฑุญูู ููฺฉู ุงุณุช ฺูุฏ ุฏููู ุทูู ุจฺฉุดุฏ..."

# ุฑุงูโุงูุฏุงุฒ ฺฉ ฺฉุงูุชูุฑ ูููุช ุจุฑุง ุงุณุชุฎุฑุงุฌ ูุงูโูุง ุงุฏูู
echo "๐ ุฑุงูโุงูุฏุงุฒ ฺฉุงูุชูุฑ ูููุช ุจุฑุง ุงุณุชุฎุฑุงุฌ ูุงูโูุง ุงุฏูู..."
docker run --name temp_django_container -d --rm python:3.11-slim bash -c "pip install django && sleep 3600"

# ฺฉูพ ูุงูโูุง ุงุฏูู ุงุฒ ฺฉุงูุชูุฑ ูููุช
echo "๐ฆ ฺฉูพ ูุงูโูุง ุงุฏูู ุงุฒ ฺฉุงูุชูุฑ ูููุช..."
DJANGO_PATH=$(docker exec temp_django_container pip show django | grep Location | awk '{print $2}')
docker exec temp_django_container bash -c "cd $DJANGO_PATH/django/contrib/admin/static && tar -cf - admin" | tar -xf - -C static/

# ุญุฐู ฺฉุงูุชูุฑ ูููุช
echo "๐งน ูพุงฺฉุณุงุฒ ฺฉุงูุชูุฑ ูููุช..."
docker stop temp_django_container

# ุชุบุฑ ูุงูฺฉุช ูุงูโูุง
echo "๐ค ุชูุธู ุฏุณุชุฑุณโูุง ูุงูโูุง..."
chmod -R 755 static

# ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ ฺฉุงูุชูุฑูุง
echo "๐ ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ ฺฉุงูุชูุฑูุง..."
docker compose up -d

# ููุชุธุฑ ุดุฏู ุจุฑุง ุฑุงูโุงูุฏุงุฒ ฺฉุงูู ุณุฑูุณ ูุจ
echo "โณ ููุชุธุฑ ุฑุงูโุงูุฏุงุฒ ฺฉุงูู ุณุฑูุณ ูุจ..."
sleep 15

# ุงุฌุฑุง ุฏุณุช collectstatic
echo "๐ง ุงุฌุฑุง ุฏุณุช collectstatic..."
docker compose exec web python manage.py collectstatic --no-input --clear

echo "โ ูุฑุขูุฏ ุฑูุน ูุดฺฉู ูุงูโูุง ุงุณุชุงุชฺฉ ุจุง ููููุช ุงูุฌุงู ุดุฏ!"
echo "๐ ุงฺฉููู ูโุชูุงูุฏ ูพูู ุงุฏูู ุฑุง ุฏุฑ ุขุฏุฑุณ http://localhost/admin ุจุฑุฑุณ ฺฉูุฏ." 